# This is simple Makefile for complex tests

RYFTONE=/ryftone
AUTH=-u admin:admin
TEXT10K=test-fake-10K.txt
TEXT100K=test-fake-100K.txt
TEXT1M=test-fake-1M.txt
TEXT10M=test-fake-10M.txt

.PHONY: all
all: test_unwind_index

# unwind index tests
.PHONY: test_unwind_index test_unwind_index1
test_unwind_index: test_unwind_index1

# unwind index test
TEXT_UNWIND_INDEX1=${TEXT100K}
AUTH_UNWIND_INDEX1=${AUTH}
test_unwind_index1: faketext "${RYFTONE}/${TEXT_UNWIND_INDEX1}"
	ryftrest -p=fhs -d=1 -q '(RAW_TEXT CONTAINS "test-fake-test")' \
		-f "${TEXT_UNWIND_INDEX1}" ${AUTH_UNWIND_INDEX1} --local --format=utf8 \
		| jq -c '.results | sort_by(._index.offset) | .[]._index' > test-unwind-1-a.txt
	ryftrest -p=fhs -d=1 -w=16 -q '(RAW_TEXT CONTAINS "test-fake-test")AND(RAW_TEXT CONTAINS FHS("test-fake-test",DIST=0))' \
		-f "${TEXT_UNWIND_INDEX1}" ${AUTH_UNWIND_INDEX1} --local --format=utf8 \
		| jq -c '.results | sort_by(._index.offset) | .[]._index' > test-unwind-1-b.txt
	ryftrest -p=fhs -d=1 -w=16 -q '(RAW_TEXT CONTAINS "test-fake-test")AND(RAW_TEXT CONTAINS FHS("test-fake-test",DIST=0))AND(RAW_TEXT CONTAINS FEDS("test-fake-test",DIST=0))' \
		-f "${TEXT_UNWIND_INDEX1}" ${AUTH_UNWIND_INDEX1} --local --format=utf8 \
		| jq -c '.results | sort_by(._index.offset) | .[]._index' > test-unwind-1-c.txt
	wc -l test-unwind-1-a.txt test-unwind-1-b.txt test-unwind-1-c.txt
	diff test-unwind-1-a.txt test-unwind-1-b.txt >/dev/null
	diff test-unwind-1-a.txt test-unwind-1-c.txt >/dev/null
	diff test-unwind-1-b.txt test-unwind-1-c.txt >/dev/null


# 10K test file
"${RYFTONE}/${TEXT10K}": faketext
	./faketext --count=10000 --pattern "${rand(64)} test-fake-test ${rand(64)}" > "${RYFTONE}/${TEXT10K}"

# 100K test file
"${RYFTONE}/${TEXT100K}": faketext
	./faketext --count=100000 --pattern "${rand(64)} test-fake-test ${rand(64)}" > "${RYFTONE}/${TEXT100K}"

# 1M test file
"${RYFTONE}/${TEXT1M}": faketext
	./faketext --count=1000000 --pattern "${rand(64)} test-fake-test ${rand(64)}" > "${RYFTONE}/${TEXT1M}"

# 10M test file
"${RYFTONE}/${TEXT10M}": faketext
	./faketext --count=10000000 --pattern "${rand(64)} test-fake-test ${rand(64)}" > "${RYFTONE}/${TEXT10M}"

# faketext utility
faketext:
	go build -o faketext ./fakegen/

# clean all fake data
clean:
	rm -f "${RYFTONE}/${TEXT10K}"
	rm -f "${RYFTONE}/${TEXT100K}"
	rm -f "${RYFTONE}/${TEXT1M}"
	rm -f "${RYFTONE}/${TEXT10M}"
	rm -f test-unwind-1-a.txt
	rm -f test-unwind-1-b.txt
	rm -f test-unwind-1-c.txt
