# This is simple Makefile for complex tests

AUTH=-u admin:admin
ADDR=-a localhost:8765

# no spaces allowed!
RYFTONE=/ryftone

TEXT10=test-fake-10.txt
TEXT10K=test-fake-10K.txt
TEXT100K=test-fake-100K.txt
TEXT1M=test-fake-1M.txt
TEXT10M=test-fake-10M.txt

CRIME10=test-fake-10.pcrime
CRIME10K=test-fake-10K.pcrime
CRIME100K=test-fake-100K.pcrime
CRIME1M=test-fake-1M.pcrime
CRIME10M=test-fake-10M.pcrime

.PHONY: all
all: test_unwind_index

# unwind index tests
.PHONY: test_unwind_index test_unwind_index1 test_unwind_index2
test_unwind_index: test_unwind_index1 test_unwind_index2

# unwind index test, AND operator
TEXT_UNWIND_INDEX1=${TEXT10}
test_unwind_index1: ${RYFTONE}/${TEXT_UNWIND_INDEX1}
	@echo "check unwind index feature on ${RYFTONE}/${TEXT_UNWIND_INDEX1} file"
	@echo "1a: call FHS(d=0) as reference..."
	ryftrest -p=fhs -d=0 -q '(RAW_TEXT CONTAINS "test-fake-test")' \
		-f "${TEXT_UNWIND_INDEX1}" ${AUTH} ${ADDR} --local --format=utf8 \
		| jq -c '.results | sort_by(._index.offset) | .[]._index' > test-unwind1a.txt
	@echo "1b: call FHS(d=1) AND FHS(d=0)..."
	ryftrest -p=fhs -d=1 -w=16 -q '(RAW_TEXT CONTAINS "test-fake-test")AND(RAW_TEXT CONTAINS FHS("test-fake-test",DIST=0,WIDTH=0))' \
		-f "${TEXT_UNWIND_INDEX1}" ${AUTH} ${ADDR} --local --format=utf8 \
		| jq -c '.results | sort_by(._index.offset) | .[]._index' > test-unwind1b.txt
	@echo "1c: call FHS(d=1) AND FHS(d=0) AND FEDS(d=0)..."
	ryftrest -p=fhs -d=1 -w=16 -q '(RAW_TEXT CONTAINS "test-fake-test")AND(RAW_TEXT CONTAINS FHS("test-fake-test",DIST=0))AND(RAW_TEXT CONTAINS FEDS("test-fake-test",DIST=0,WIDTH=0))' \
		-f "${TEXT_UNWIND_INDEX1}" ${AUTH} ${ADDR} --local --format=utf8 \
		| jq -c '.results | sort_by(._index.offset) | .[]._index' > test-unwind1c.txt
	wc -l "${RYFTONE}/${TEXT_UNWIND_INDEX1}" test-unwind1a.txt test-unwind1b.txt test-unwind1c.txt
	diff test-unwind1a.txt test-unwind1b.txt >/dev/null
	diff test-unwind1a.txt test-unwind1c.txt >/dev/null
	@echo "test PASSED"

# unwind index test, OR operator
TEXT_UNWIND_INDEX2=${CRIME10}
test_unwind_index2: ${RYFTONE}/${TEXT_UNWIND_INDEX2}
	@echo "check unwind index feature on ${RYFTONE}/${TEXT_UNWIND_INDEX2} file"
	@echo "2a: call FHS(d=0) as reference..."
	# have to duplicate reference output! de-duplication is not supported yet!
	ryftrest -p=fhs -d=0 -q '(RECORD.primaryType CONTAINS "test-fake-test")' \
		-f "${TEXT_UNWIND_INDEX2}" ${AUTH} ${ADDR} --local --format=utf8 \
		| jq -c '.results + .results | sort_by(._index.offset) | .[]._index' > test-unwind2a.txt
	@echo "2b: call FHS(d=1) OR FHS(d=0)..."
	ryftrest -p=fhs -d=1 -w=16 -q '(RECORD.primaryType CONTAINS "test-fake-test")OR(RECORD.primaryType CONTAINS FHS("test-fake-test",DIST=0,WIDTH=0))' \
		-f "${TEXT_UNWIND_INDEX2}" ${AUTH} ${ADDR} --local --format=utf8 \
		| jq -c '.results | sort_by(._index.offset) | .[]._index' > test-unwind2b.txt
	@echo "2c: call FHS(d=1) AND (FHS(d=1) OR FHS(d=0))..."
	ryftrest -p=fhs -d=1 -w=16 -q '(RECORD.primaryType CONTAINS "test-fake-test")AND((RECORD.primaryType CONTAINS "test-fake-test")OR(RECORD.primaryType CONTAINS FHS("test-fake-test",DIST=0,WIDTH=0)))' \
		-f "${TEXT_UNWIND_INDEX2}" ${AUTH} ${ADDR} --local --format=utf8 \
		| jq -c '.results | sort_by(._index.offset) | .[]._index' > test-unwind2c.txt
	@echo "2d: call (FHS(d=1) OR FHS(d=0)) AND FHS(d=1)..."
	ryftrest -p=fhs -d=1 -w=16 -q '((RECORD.primaryType CONTAINS "test-fake-test")OR(RECORD.primaryType CONTAINS FHS("test-fake-test",DIST=0))) AND (RECORD.primaryType CONTAINS FHS("test-fake-test",WIDTH=0))' \
		-f "${TEXT_UNWIND_INDEX2}" ${AUTH} ${ADDR} --local --format=utf8 \
		| jq -c '.results | sort_by(._index.offset) | .[]._index' > test-unwind2d.txt
	wc -l "${RYFTONE}/${TEXT_UNWIND_INDEX2}" test-unwind2a.txt test-unwind2b.txt test-unwind2c.txt test-unwind2d.txt
	diff test-unwind2a.txt test-unwind2b.txt >/dev/null
	diff test-unwind2a.txt test-unwind2c.txt >/dev/null
	diff test-unwind2a.txt test-unwind2d.txt >/dev/null
	@echo "test PASSED"

# 10 test file
${RYFTONE}/${TEXT10}: faketext
	./faketext --count=10 --pattern '$${rand(64)} test-fake-test $${rand(64)}' > "${RYFTONE}/${TEXT10}"
${RYFTONE}/${CRIME10}: faketext
	./faketext --count=10 --pattern '<rec><ID>id_$${rand(16)}</ID><PrimaryType>$${rand(16)} test-fake-test $${rand(16)}</PrimaryType></rec>' > "${RYFTONE}/${CRIME10}"

# 10K test file
${RYFTONE}/${TEXT10K}: faketext
	./faketext --count=10000 --pattern '$${rand(64)} test-fake-test $${rand(64)}' > "${RYFTONE}/${TEXT10K}"

# 100K test file
${RYFTONE}/${TEXT100K}: faketext
	./faketext --count=100000 --pattern '$${rand(64)} test-fake-test $${rand(64)}' > "${RYFTONE}/${TEXT100K}"

# 1M test file
${RYFTONE}/${TEXT1M}: faketext
	./faketext --count=1000000 --pattern '$${rand(64)} test-fake-test $${rand(64)}' > "${RYFTONE}/${TEXT1M}"

# 10M test file
${RYFTONE}/${TEXT10M}: faketext
	./faketext --count=10000000 --pattern '$${rand(64)} test-fake-test $${rand(64)}' > "${RYFTONE}/${TEXT10M}"

# faketext utility
faketext:
	go build -o faketext ./fakegen/

# clean all fake data
clean:
	rm -f "${RYFTONE}/${TEXT10}"
	rm -f "${RYFTONE}/${TEXT10K}"
	rm -f "${RYFTONE}/${TEXT100K}"
	rm -f "${RYFTONE}/${TEXT1M}"
	rm -f "${RYFTONE}/${TEXT10M}"
	rm -f "${RYFTONE}/${CRIME10}"
	rm -f "${RYFTONE}/${CRIME10K}"
	rm -f "${RYFTONE}/${CRIME100K}"
	rm -f "${RYFTONE}/${CRIME1M}"
	rm -f "${RYFTONE}/${CRIME10M}"
	rm -f test-unwind1a.txt
	rm -f test-unwind1b.txt
	rm -f test-unwind1c.txt
	rm -f test-unwind2a.txt
	rm -f test-unwind2b.txt
	rm -f test-unwind2c.txt
	rm -f test-unwind2d.txt
